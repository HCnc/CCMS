<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>储能电源系统控制管理系统</title>
</head>
<script src="./js/jQuery3.2.1.js"></script>
<script src="./js/bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
<link href="./js/bootstrap-3.3.7-dist/css/bootstrap.min.css" rel="stylesheet">
<link href="./css/style.css" rel="stylesheet">
<script src="js/Websocket/websocketstore.js"></script>

<!-- <script src="https://static.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script> -->
<script src="build/eventemitter2.min.js"></script>
<script src="build/roslib.js"></script>
<script src="build/bean.js"></script>

<script>
  // Connecting to ROS
  // -----------------
  var ros = new ROSLIB.Ros();

  // If there is an error on the backend, an 'error' emit will be emitted.
  ros.on('error', function(error) {
    document.getElementById('connecting').style.display = 'none';
    document.getElementById('connected').style.display = 'none';
    document.getElementById('closed').style.display = 'none';
    document.getElementById('error').style.display = 'inline';
    console.log(error);
  });

  // Find out exactly when we made a connection.
  ros.on('connection', function() {
    console.log('Connection made!');
    document.getElementById('connecting').style.display = 'none';
    document.getElementById('error').style.display = 'none';
    document.getElementById('closed').style.display = 'none';
    document.getElementById('connected').style.display = 'inline';
  });

  ros.on('close', function() {
    console.log('Connection closed.');
    document.getElementById('connecting').style.display = 'none';
    document.getElementById('connected').style.display = 'none';
    document.getElementById('closed').style.display = 'inline';
  });

  // Create a connection to the rosbridge WebSocket server.
  //ros.connect('ws://localhost:9090');
  ros.connect('ws://localhost:8888');
  //ros.connect('ws://192.168.30.109:8888');

  // Publishing a Topic
  // ------------------

  // First, we create a Topic object with details of the topic's name and message type.
  var cmdVel = new ROSLIB.Topic({
    ros : ros,
    name : '/cmd_vel',
    messageType : 'geometry_msgs/Twist'
  });

  // Then we create the payload to be published. The object we pass in to ros.Message matches the
  // fields defined in the geometry_msgs/Twist.msg definition.
  var twist = new ROSLIB.Message({
    linear : {
      x : 0.1,
      y : 0.2,
      z : 0.3
    },
    angular : {
      x : -0.1,
      y : -0.2,
      z : -0.3
    }
  });

  // And finally, publish.
  cmdVel.publish(twist);

  //Subscribing to a Topic
  //----------------------

  // Like when publishing a topic, we first create a Topic object with details of the topic's name
  // and message type. Note that we can call publish or subscribe on the same topic object.
  var listener = new ROSLIB.Topic({
    ros : ros,
    name : '/listener',
    messageType : 'std_msgs/String'
  });


  // Then we add a callback to be called every time a message is published on this topic.
  listener.subscribe(function(message) {
    console.log('Received message on ' + listener.name + ': ' + message.data);

    // If desired, we can unsubscribe from the topic as well.
    //listener.unsubscribe();
  });


  //create topic
  var send_data = new ROSLIB.Topic({
    ros : ros,
    name : '/send',
    messageType : 'msg_test/sendData'
  });

  //create message
  // var send = new ROSLIB.Message({
  //    data1 : 1
  // });

  //publish
  //send_data.publish(send);

  send_msg = function(msg){
    send_data.publish(msg);
  }
  

  var d1_data = new ROSLIB.Topic({
    ros : ros,
    name : '/simple_can_msg',//'/simple_can_msg',
    messageType : 'ccms_pro/UnpackingCanData1'//'ccms_pro/UnpackingCanData1'
  });

  d1_data.subscribe(function(message) {
	console.log('in di_data')
	//console.log(message.Module_Voltage)

    data1.setting(message.Module_Voltage,                                  
                  message.Module_Capacitance_Temperature,                      
                  message.Module_Board_Temperature,                    
                  message.Module_Voltage_Overvoltage_Abnormal_Bit0,  
                  message.Module_Voltage_Overvoltage_Abnormal_Bit1,
                  message.Module_Voltage_Overvoltage_Abnormal_Bit2,
                  message.Module_Voltage_Overvoltage_Abnormal_Bit3,
                  message.Module_Voltage_Overvoltage_Abnormal_Bit4,
                  message.Module_Voltage_Overvoltage_Abnormal_Bit5,
                  message.Module_Voltage_Overvoltage_Abnormal_Bit6,
                  message.Module_Voltage_Overvoltage_Abnormal_Bit7,       
                  message.Module_Capacity_Abnormal_Bit0,
                  message.Module_Capacity_Abnormal_Bit1,
                  message.Module_Capacity_Abnormal_Bit2,
                  message.Module_Capacity_Abnormal_Bit3,
                  message.Module_Capacity_Abnormal_Bit4,
                  message.Module_Capacity_Abnormal_Bit5,
                  message.Module_Capacity_Abnormal_Bit6,
                  message.Module_Capacity_Abnormal_Bit7,                        
                  message.Voltage_Equalization_Fault,                            
                  message.Voltage_Sampling_Error,                     
                  message.Temperature_Sampling_Error,                       
                  message.Abnormal_Voltage_Data,                                 
                  message.Module_Voltage_Overvoltage_Warning_Bit0,
                  message.Module_Voltage_Overvoltage_Warning_Bit1,
                  message.Module_Voltage_Overvoltage_Warning_Bit2,
                  message.Module_Voltage_Overvoltage_Warning_Bit3,
                  message.Module_Voltage_Overvoltage_Warning_Bit4,
                  message.Module_Voltage_Overvoltage_Warning_Bit5,
                  message.Module_Voltage_Overvoltage_Warning_Bit6,
                  message.Module_Voltage_Overvoltage_Warning_Bit7 );

    //data1.getting();
    child.window.deal_data1(data1);

  });

  var d5_data = new ROSLIB.Topic({
    ros : ros,
    name : '/simple_can5_msg',
    messageType : 'msg_test/UnpackingCanData5'//'ccms_pro/UnpackingCanData5'
  });

  d5_data.subscribe(function(message){
    console.log("in d5_data")
    data5.setting(message.Balanced_data_number,
                  message.Modules_Above_Threshold_Voltage,
                  message.Moduel_Average_Voltage,
                  message.Module_Voltage_Threshold,
                  message.Minimum_Module_Voltage)

    child.window.deal_data5(data5);
  })

  function send_time_and_id(id){
    // var timestamp1 = (new Date()).valueOf();
    // console.log(timestamp1)
    var start_time = document.getElementById("s").value;
    var end_time = document.getElementById("e").value;
    start_time = parseInt(start_time);
    end_time = parseInt(end_time)
    console.log("endtime");
    console.log(typeof(1));
    console.log(typeof(start_time));
    console.log(typeof(end_time));
    
    var msg = new ROSLIB.Message({
      Power_Number : id,
      Module_Number : 1,
      Block_Number : 1,
      StartTime :start_time,
      EndTime :end_time
    })

    send_msg(msg)

    console.log("start_time: " + start_time + "\n" +
                "end_time: " + end_time + "\n" + 
                "ID: " + id)
  }
  

</script>
<body style="overflow-y:hidden">
<nav class="navbar navbar-inverse">
      <div class="row">
          <div class="col-md-12"><img src="images/bg/bg.png" width="100%" height="68px"></div>
          </div>
      </div>
</nav>
<!--左面导航开始-->
<div class="leftMenu">
  <input type="hidden" id="s"/>
  <input type="hidden" id="e"/>

       <dl>
         <dt>
           <div id="statusIndicator">
              <p id="connecting">
                Connecting to rosbridge...
              </p>
              <p id="connected" style="color:#00D600; display:none">
                Connected
              </p>
              <p id="error" style="color:#FF0000; display:none">
                Error in the backend!
              </p>
              <p id="closed" style="display:none">
                Connection closed.
              </p>
            </div>
         </dt>
       </dl>

        <!--实时模块开始-->
       <dl>
           <dt class="menuFir">实时监测</dt>
           <dd class="ddFir" style="display: block;">
               <dl>
                   <dt class="menuSec">一号电源</dt>
                   <dd >
                       <ul>
                           <li _link="./html/now/onePowerNow.html">电源监控</li>
                           <li _link="./html/now/onePowerModnow.html">模组状况监控</li>
                       </ul>
                   </dd>
               </dl>
               <dl>
                   <dt class="menuSec">二号电源</dt>
                   <dd>
                       <ul>
                           <li _link="./html/now/twoPowerNow.html">电源监控</li>
                           <li _link="./html/now/twoPowerModnow.html">模组状况监控</li>
                       </ul>
                   </dd>
               </dl>
               <dl>
                   <dt class="menuSec">三号电源</dt>
                   <dd>
                       <ul>
                           <li _link="./html/now/threePowerNow.html">电源监控</li>
                           <li _link="./html/now/threePowerModnow.html">模组状况监控</li>
                       </ul>
                   </dd>
               </dl>
           </dd>
       </dl>
        <!--实时模块结束-->

        <!--历史模块开始-->
        <dl>
            <dt class="menuFir">历史数据</dt>
            <dd class="ddFir">
                <dl>
                    <dt class="menuSec">一号电源</dt>
                    <dd>
                        <ul>
                             <li _link="./html/history/onePowerHistory.html">电源历史数据</li>
                            <li _link="./html/history/onePowerModHistory.html">模组历史数据</li>
                        </ul>
                    </dd>
                </dl>
                <dl>
                    <dt class="menuSec">二号电源</dt>
                    <dd>
                        <ul>
                            <li _link="./html/history/twoPowerHistory.html">电源历史数据</li>
                            <li _link="./html/history/twoPowerModHistory.html">模组历史数据</li>
                        </ul>
                    </dd>
                </dl>
                <dl>
                    <dt class="menuSec">三号电源</dt>
                    <dd>
                        <ul>
                            <li _link="./html/history/threePowerHistory.html">电源历史数据</li>
                            <li _link="./html/history/threePowerModHistory.html">模组历史数据</li>
                        </ul>
                    </dd>
                </dl>
            </dd>
        </dl>
        <!--历史模块结束-->
        
       <!-- 故障查询模块开始-->
       <dl>
           <dt class="menuFir">故障检测</dt>
           <dd class="ddFir">
               <dl>
                   <dt></dt>
                   <dd>
                       <ul>
                           <li _link="./html/breakdown/breakdown.html">故障检测</li>
                       </ul>
                   </dd>
               </dl>
           </dd>
       </dl>
       <!-- 故障查询模块结束-->

        <!--账户管理开始-->
        <dl>
            <dt class="menuFir">我的管理</dt>
            <dd class="ddFir">
                <dl>
                    <dt></dt>
                    <dd>
                        <ul>
                            <li _link="./html/account/account.html">我的账户</li>
                            <li>
                              <div>
                                <a onclick="send_a()">test send</a>
                              </div>
                            </li>
                        </ul>
                    </dd>
                </dl>
            </dd>
        </dl>
        <!--账户管理结束-->
</div>
<!--左面导航结束-->

<!--右面显示的内容开始-->
<div class="rightMain">
    <div class="rightContent">
        <iframe name ="child" id="main" src="html/now/onePowerNow.html" scrolling="yes" frameborder="0"></iframe>
    </div>
</div>
<!--右面显示的内容结束-->

<script src="./js/main/script.js"></script>
</body>
</html>
